# 매장목표매출 앱 구조 문서

## 개요

매장목표매출 앱은 영업부의 목표 매출 달성 현황을 조회하고 분석하는 Retool 애플리케이션입니다. 월별, 연도별, 기간별로 매출 현황을 조회할 수 있으며, 사업부 및 브랜드별 필터링 기능을 제공합니다.

## 앱 구조

### 파일 구조

```
매장목표매출/
├── main.rsx              # 메인 앱 레이아웃
├── functions.rsx         # 전역 함수 및 쿼리 정의
├── header.rsx           # 헤더 프레임 (Top Navigation 모듈)
├── sidebar.rsx          # 사이드바 (필터 컨트롤)
├── metadata.json        # 앱 메타데이터
├── src/
│   ├── monthlySelect.rsx    # 월별/연도별/기간별 선택 컨테이너
│   └── container2.rsx       # 연간 요약 통계 컨테이너
└── lib/
    ├── shopInfoQuery.sql                    # 매장 정보 쿼리
    ├── monthlySalesQuery.sql                # 월별 매출 쿼리
    ├── periodicSalesQuery.sql               # 기간별 매출 쿼리
    ├── monthlySalesByStyleQuery.sql         # 월별 스타일별 매출 쿼리
    ├── periodicSalesByStyleQuery.sql        # 기간별 스타일별 매출 쿼리
    └── salesBySecondLevelWithBiz.js         # 2차 분류별 매출 변환 함수
```

---

## 1. 데이터를 가져오는 Flow

### 1.1 초기 데이터 로딩

앱이 로드되면 다음 순서로 데이터를 가져옵니다:

1. **매장 정보 조회** (`shopInfoQuery`)
   - 앱 로드 시 자동 실행 (`monthlySelect` Container의 Event)
   - 데이터베이스: `clickhouse-dw`
   - 테이블: `agabang_dw.daily_shop_sales_by_dimension`
   - 목적: 사업부(biz_cd, biz_nm) 및 브랜드(br_cd, br_nm) 목록 조회
   - 캐시: 3600초 (1시간)

2. **월별 매출 데이터 조회** (`monthlySalesQuery`)
   - 자동 실행 (초기 로드 시)
   - 데이터베이스: `clickhouse-dw`
   - 테이블: `agabang_dw.f_daily_sales_by_shop`
   - 목적: 월별 매출 및 목표 매출 데이터 조회
   - 캐시: 3600초 (1시간)
   - 필터링: 현재 날짜 이전 데이터만 조회

3. **기간별 매출 데이터 조회** (`periodicSalesQuery`)
   - 사용자가 기간을 선택할 때 실행 (`dateRange`의 submit 이벤트)
   - 데이터베이스: `clickhouse-dw`
   - 테이블: `agabang_dw.f_daily_sales_by_shop`
   - 목적: 사용자 지정 기간의 매출 데이터 조회
   - 캐시: 10800초 (3시간)

4. **스타일별 매출 데이터 조회**
   - `monthlySalesByStyleQuery`: 월별 스타일별 매출 (캐시 없음)
   - `periodicSalesByStyleQuery`: 기간별 스타일별 매출 (캐시: 10800초)
   - 데이터베이스: `clickhouse-dw`
   - 테이블: `agabang_dw.daily_shop_sales_by_dimension`
   - 목적: 상품 종목별 상세 매출 분석

### 1.2 데이터 흐름도

```
[앱 로드]
    ↓
[shopInfoQuery 실행] → [사업부/브랜드 목록]
    ↓
[monthlySalesQuery 실행] → [월별 매출 데이터]
    ↓
[사용자 필터 선택]
    ↓
[bizMultiSelect / brandMultiSelect 변경]
    ↓
[monthlySalesQuery 데이터 필터링] (transformer에서)
    ↓
[프론트엔드 컴포넌트에 표시]
```

### 1.3 쿼리 실행 조건

- **shopInfoQuery**: 앱 로드 시 자동 실행
- **monthlySalesQuery**: 앱 로드 시 자동 실행
- **periodicSalesQuery**: `dateRange` 컴포넌트의 submit 이벤트 발생 시 실행
- **monthlySalesByStyleQuery**: 월별 탭에서 자동 실행
- **periodicSalesByStyleQuery**: 기간별 탭에서 자동 실행

---

## 2. 쿼리, 코드와 프론트엔드와의 상호작용

### 2.1 쿼리 정의 및 변환

#### 2.1.1 shopInfoQuery

**SQL 쿼리** (`lib/shopInfoQuery.sql`):
```sql
SELECT DISTINCT
  biz_cd, biz_nm, br_cd, br_nm, sub_br_cd, sub_br_nm
FROM agabang_dw.daily_shop_sales_by_dimension
WHERE YEAR(sale_dt) >= YEAR(today())
```

**변환 함수**: `formatDataAsArray(data)`
- 배열 형태로 변환하여 사이드바의 Multiselect 컴포넌트에 전달

**프론트엔드 연결**:
- `sidebar.rsx`의 `bizMultiSelect`와 `brandMultiSelect`에 데이터 바인딩
- 중복 제거 및 정렬 로직 포함

#### 2.1.2 monthlySalesQuery

**SQL 쿼리** (`lib/monthlySalesQuery.sql`):
```sql
SELECT 
  yr as time_unit, ym, yr, mth as month,
  shop_cd, shop_nm, biz_cd, biz_nm, br_cd, br_nm,
  tp_cd, tp_nm, tp_group_nm, team_cd, team_nm,
  user_cd, user_nm, area_cd, area_nm,
  onoff_flag, is_flex,
  SUM(rev) / 1000000 as rev,
  COALESCE(SUM(target_sales), 0) / 1000000 as target_sales
FROM agabang_dw.f_daily_sales_by_shop
WHERE date_format(dt, '%m-%d') < date_format(CURDATE(), '%m-%d')
GROUP BY ...
```

**변환 함수**:
```javascript
let arrData = formatDataAsArray(data)
const bizLists = {{ bizMultiSelect.value }}
const brLists = {{ brandMultiSelect.value }}
arrData = arrData.filter(item => 
  bizLists.includes(item.biz_cd) && brLists.includes(item.br_cd)
)
return formatDataAsObject(arrData)
```

**프론트엔드 연결**:
- 월별 탭: `monthlySelect.rsx`의 `revStatTblModule2` 모듈에 전달
- 연도별 탭: 통계 컴포넌트 및 달성률 ProgressCircle에 사용
- 필터링: transformer에서 사업부/브랜드 필터 적용

#### 2.1.3 periodicSalesQuery

**SQL 쿼리** (`lib/periodicSalesQuery.sql`):
- `dateRange` 컴포넌트의 값(`dateRange.value.start`, `dateRange.value.end`)을 사용하여 동적 필터링
- 월-일 형식으로 날짜 비교

**변환 함수**: `monthlySalesQuery`와 동일한 필터링 로직

**프론트엔드 연결**:
- 기간별 탭의 `revStatTblModule2` 모듈에 전달
- `dateRange` 컴포넌트의 submit 이벤트로 쿼리 실행

#### 2.1.4 스타일별 매출 쿼리

**monthlySalesByStyleQuery**:
- 선택된 월(`monthSelect.value + 1`)에 해당하는 데이터 조회
- 사업부/브랜드 필터 적용

**periodicSalesByStyleQuery**:
- 선택된 기간에 해당하는 데이터 조회
- `salesBySecondLevelWithBiz` 함수로 변환하여 연도별 요약 테이블에 표시

### 2.2 JavaScript 함수

#### 2.2.1 salesBySecondLevelWithBiz

**위치**: `lib/salesBySecondLevelWithBiz.js`

**기능**:
1. `transformSalesData`: 스타일별 매출 데이터를 사업부별, 연도별, 2차 분류별로 그룹화
2. `calculateYoYGrowth`: 전년 대비 신장율 계산

**데이터 변환 과정**:
```
원본 데이터 (periodicSalesByStyleQuery.data)
  ↓
[오프라인 필터링]
  ↓
[transformSalesData] → 사업부-연도별 그룹화, 2차 분류별 매출 집계
  ↓
[calculateYoYGrowth] → 전년 대비 신장율 계산
  ↓
최종 결과 (연도별 요약 테이블에 표시)
```

**프론트엔드 연결**:
- `monthlySelect.rsx`의 `salesBySecondLevelTbl` 테이블에 바인딩
- 각 카테고리(기초류, 외의류, 발육 등)별 매출 및 신장율 표시

### 2.3 프론트엔드 컴포넌트와의 상호작용

#### 2.3.1 사이드바 필터 (sidebar.rsx)

**컴포넌트**:
- `bizMultiSelect`: 사업부 선택
- `brandMultiSelect`: 브랜드 선택

**상호작용**:
1. `shopInfoQuery.data`에서 사업부/브랜드 목록 추출
2. 사용자 선택 값이 변경되면 쿼리의 transformer에서 자동 필터링
3. 기본값: 사용자 그룹에 따라 자동 설정
   - admin / 아가방 부문 → A1
   - 에뜨와 부문 → A4
   - 디즈니 부문 → DS

#### 2.3.2 메인 컨테이너 (monthlySelect.rsx)

**탭 구조**:
1. **월별현황** (viewKey: "monthly")
   - `monthSelect`: 월 선택 (SegmentedControl)
   - `revStatTblModule2`: 매출 현황 테이블 모듈
   - 데이터: `monthlySalesQuery.data` (선택된 월 필터링)

2. **연도요약** (viewKey: "yearly")
   - 연간 총 매출/목표 매출 통계 (`container2.rsx`)
   - 월별 달성률 ProgressCircle (12개)
   - 상품종목별 매출 상세 테이블 (`salesBySecondLevelTbl`)

3. **기간별현황** (viewKey: "periodic")
   - `dateRange`: 기간 선택
   - `revStatTblModule2`: 매출 현황 테이블 모듈
   - 데이터: `periodicSalesQuery.data`

#### 2.3.3 모듈 사용 (revStatTblModule2)

**모듈 위치**: `apps/99. Module/revStatTblModule2`

**입력 데이터**:
- `inputData`: 월별/기간별 매출 데이터
- `inputDataByStyle`: 스타일별 매출 데이터
- `inputDateRange`: 조회 기간

**데이터 전달 방식**:
```rsx
<Module
  id="revStatTblModule2"
  inputData="{{ formatDataAsObject(...) }}"
  inputDataByStyle="{{ monthlySalesByStyleQuery.data }}"
  inputDateRange="{{ ... }}"
  name="revStatTblModule2"
/>
```

---

## 3. 프론트엔드와 데이터의 연결

### 3.1 데이터 바인딩 구조

#### 3.1.1 State 관리

**전역 State** (`functions.rsx`):
- `thisYear`: 현재 연도
- `monthList`: 1~12월 배열

**로컬 State**:
- 각 컴포넌트 내에서 쿼리 데이터를 직접 참조

#### 3.1.2 데이터 변환 파이프라인

```
[SQL 쿼리 결과]
    ↓
[formatDataAsArray] → 배열로 변환
    ↓
[필터링] (transformer 또는 컴포넌트 내)
    ↓
[formatDataAsObject] → 객체로 변환 (필요시)
    ↓
[프론트엔드 컴포넌트]
```

### 3.2 주요 데이터 연결 포인트

#### 3.2.1 월별 탭

**데이터 흐름**:
```rsx
monthlySalesQuery.data
  ↓ formatDataAsArray
  ↓ filter (month == monthSelect.value + 1)
  ↓ formatDataAsObject
  ↓ revStatTblModule2.inputData
```

**코드 위치**: `src/monthlySelect.rsx:46`
```rsx
inputData="{{ formatDataAsObject(formatDataAsArray(monthlySalesQuery.data).filter(obj => obj.month == (monthSelect.value + 1))) }}"
```

#### 3.2.2 연도별 탭

**총 매출/목표 매출 통계**:
```rsx
monthlySalesQuery.data
  ↓ formatDataAsArray
  ↓ filter (yr === 2025 && onoff_flag === '오프라인')
  ↓ reduce (rev 합계)
  ↓ Statistic 컴포넌트
```

**월별 달성률**:
```rsx
monthlySalesQuery.data
  ↓ formatDataAsArray
  ↓ filter (month === item + 1 && yr === 현재연도)
  ↓ reduce (rev 합계 / target_sales 합계 * 100)
  ↓ ProgressCircle.value
```

**상품종목별 매출 테이블**:
```rsx
periodicSalesByStyleQuery.data
  ↓ salesBySecondLevelWithBiz 함수
  ↓ transformSalesData + calculateYoYGrowth
  ↓ salesBySecondLevelTbl.data
```

#### 3.2.3 기간별 탭

**데이터 흐름**:
```rsx
dateRange.value 변경
  ↓ submit 이벤트
  ↓ periodicSalesQuery 실행
  ↓ periodicSalesQuery.data
  ↓ revStatTblModule2.inputData
```

**코드 위치**: `src/monthlySelect.rsx:429`
```rsx
inputData="{{ periodicSalesQuery.data }}"
```

### 3.3 실시간 데이터 업데이트

#### 3.3.1 필터 변경 시

1. 사용자가 `bizMultiSelect` 또는 `brandMultiSelect` 변경
2. 쿼리 transformer에서 자동 필터링
3. 프론트엔드 컴포넌트 자동 업데이트 (Retool의 반응형 바인딩)

#### 3.3.2 월 선택 변경 시

1. 사용자가 `monthSelect` 변경
2. `monthlySelect.rsx`의 필터링 로직 실행
3. `revStatTblModule2` 모듈에 새로운 데이터 전달

#### 3.3.3 기간 선택 변경 시

1. 사용자가 `dateRange` 변경
2. submit 이벤트 발생 (debounce 적용)
3. `periodicSalesQuery` 실행
4. 모듈에 새로운 데이터 전달

### 3.4 데이터 포맷팅

#### 3.4.1 금액 단위

- SQL 쿼리에서 `/ 1000000`으로 백만원 단위 변환
- 프론트엔드에서 "(단위: 백만원)" 표시

#### 3.4.2 날짜 포맷

- `moment.js` 사용
- 형식: `YYYY-MM-DD`
- 예: `moment().startOf("year").format("YYYY-MM-DD")`

#### 3.4.3 퍼센트 계산

- 달성률: `(실제매출 / 목표매출) * 100`
- 신장율: `((올해매출 - 작년매출) / 작년매출) * 100`

---

## 요약

### 데이터 흐름 요약

1. **초기 로드**: `shopInfoQuery` → 필터 옵션 생성 → `monthlySalesQuery` → 메인 화면 표시
2. **필터 변경**: 사용자 선택 → transformer 필터링 → 컴포넌트 업데이트
3. **탭 전환**: 탭 선택 → 해당 쿼리 실행/필터링 → 모듈에 데이터 전달
4. **기간 선택**: 날짜 선택 → `periodicSalesQuery` 실행 → 모듈 업데이트

### 주요 특징

- **캐싱**: 쿼리별로 1~3시간 캐싱으로 성능 최적화
- **필터링**: transformer에서 사업부/브랜드 필터 적용
- **모듈화**: `revStatTblModule2` 모듈 재사용
- **반응형**: Retool의 데이터 바인딩으로 자동 업데이트
- **데이터 변환**: JavaScript 함수로 복잡한 데이터 가공

