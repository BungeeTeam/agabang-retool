# 리오더 앱 계산 불일치 분석 보고서

**작성일**: 2026-01-26
**대상 앱**: 시즌 리오더 - 에뜨와 vs 시즌 리오더 시뮬레이션 - 에뜨와

---

## 문제 상황

두 앱에서 동일한 변수를 설정했을 때 리오더 수량 계산 결과가 다르게 나타남:
- **컬러 단위**: 성장률 0%로 설정 시 일치
- **사이즈 단위**: 성장률 0%로 설정해도 **불일치** 발생

시뮬레이션 앱에서 리오더 수량이 더 크게 계산되는 경향

---

## 분석 대상 파일

### 시즌 리오더 앱
- 메인 로직: `apps/99. Module/리오더/(module) 시즌 리오더 메인 테이블/lib/getSelectedItems.js`
- 데이터 쿼리: `apps/99. Module/리오더/(module) 시즌 리오더 메인 테이블/lib/get_item_list.sql`

### 시즌 리오더 시뮬레이션 앱
- 계산 로직 문서: `apps/01. EttoiApp/02. 리오더/시즌 리오더 시뮬레이션 - 에뜨와/src/modalFrame1.rsx`
- UI 컴포넌트: `apps/01. EttoiApp/02. 리오더/시즌 리오더 시뮬레이션 - 에뜨와/src/container4.rsx`
- 데이터 저장: `apps/01. EttoiApp/02. 리오더/시즌 리오더 시뮬레이션 - 에뜨와/lib/saveColorEdits.js`

---

## 발견된 차이점

### 1. 컬러 단위 계산 차이

#### 1-1. 일평균 판매량 계산 방식

| 항목 | 시즌 리오더 앱 | 시뮬레이션 앱 |
|------|---------------|---------------|
| **일 판매량** | `최근 7일 판매량 ÷ 7` | `MAX(최근 7일 판매량 ÷ 7, 누적 판매량 ÷ 판매일수)` |
| **매장당 일 판매량** | `최근 7일 판매량 ÷ (매장수 × 7)` | `일 판매량 ÷ 매장수` |

**시즌 리오더 앱 코드** (getSelectedItems.js:95-97):
```javascript
const shopDailySales = shopCount > 0 ?
                       safeNumber(item.weekly_7d_sale_qty) / (shopCount * 7) : 0;
```

**시뮬레이션 앱 공식** (modalFrame1.rsx:139-140):
```
일 판매량 = MAX(최근 7일 판매량 ÷ 7, 누적 판매량 ÷ 판매일수)
매장당 일 판매량 = 일 판매량 ÷ 매장수
```

**영향**:
- 시뮬레이션 앱은 MAX 함수로 더 큰 값을 선택하므로 일 판매량이 높게 계산될 수 있음
- 누적 판매 기간이 길고 최근 판매가 저조한 경우 차이가 크게 발생

#### 1-2. 성장률 적용 방식 (추정)

**의심되는 문제점**:
- 사용자가 성장률 100%를 입력할 때 `1 + 1 = 2.0`으로 처리되는지 확인 필요
- 시즌 리오더 앱에서는 `defaultGrowthRate = 1.0` (100% = ×1.0)으로 정의

**시즌 리오더 앱 코드** (getSelectedItems.js:44):
```javascript
const defaultGrowthRate = 1.0;  // 100%를 1.0으로 처리
```

**확인 필요**:
- 시뮬레이션 앱에서 사용자 입력 100%를 어떻게 변환하는지
- 1.0으로 처리하는지, 2.0으로 처리하는지

---

### 2. 사이즈 단위 계산 차이 (핵심)

성장률 0%일 때 컬러는 일치하지만 사이즈가 불일치하는 근본 원인

#### 2-1. 사이즈 비율 계산 기준

| 앱 | 사이즈 비율 기준 | 코드 위치 |
|---|---|---|
| 시즌 리오더 | **판매 비율** (`sizeSalesQty / totalSizeSalesQty`) | getSelectedItems.js:148 |
| 시뮬레이션 | **출고 비율** (`사이즈별 출고 수량 ÷ 전체 출고 수량`) | modalFrame1.rsx:147 |

**시즌 리오더 앱 코드** (getSelectedItems.js:136-148):
```javascript
const totalSizeSalesQty = sizeItems.reduce((sum, size) =>
    sum + safeNumber(size.tot_sale_qty), 0);

const sizeSalesRatio = totalSizeSalesQty > 0 ?
    sizeSalesQty / totalSizeSalesQty : 0;
```

**시뮬레이션 앱 공식** (modalFrame1.rsx:147):
```
사이즈 비율 = 사이즈별 출고 수량 ÷ 전체 출고 수량
```

#### 2-2. 사이즈별 예상 판매량 계산 방식

| 앱 | 계산 방식 | 특징 |
|---|---|---|
| 시즌 리오더 | 사이즈별로 **독립적으로** 계산 | 각 사이즈의 최근 7일 판매량 기반 |
| 시뮬레이션 | 컬러 예상 판매량을 **비율로 분배** | 컬러 전체 값을 사이즈로 나눔 |

**시즌 리오더 앱 코드** (getSelectedItems.js:157-161):
```javascript
// 사이즈별로 독립적으로 계산
const sizeDailySales = safeNumber(sizeItem.weekly_7d_sale_qty) / (shopCount * 7);
const sizeExpectedSales = daysUntilSalesEnd * shopCount * sizeDailySales * defaultGrowthRate;
const sizeShortageQty = Math.max(0, sizeExpectedSales - sizeStock);
```

**시뮬레이션 앱 공식** (modalFrame1.rsx:148-149):
```
사이즈별 예상 판매량 = 컬러 예상 판매량 × 사이즈별 판매비 × 성장률
사이즈별 부족 수량 = MAX(0, 사이즈별 예상 판매량 - 사이즈별 재고)
```

#### 2-3. 사이즈별 리오더 수량 분배 방식

| 앱 | 분배 기준 | 코드 |
|---|---|---|
| 시즌 리오더 | **판매 비율** | `reorderFinalQty × sizeSalesRatio` |
| 시뮬레이션 | **출고 비율** (추정) | `컬러 리오더 수량 × 사이즈 비율` |

**시즌 리오더 앱 코드** (getSelectedItems.js:152):
```javascript
const sizeReorderQty = Math.ceil(reorderFinalQty * sizeSalesRatio / 10) * 10;
```

**시뮬레이션 앱 공식** (modalFrame1.rsx:150):
```
사이즈별 리오더 수량 = CEIL(컬러 리오더 수량 × 사이즈 비율 ÷ 10) × 10
```

#### 2-4. 성장률 이중 적용 가능성

시뮬레이션 앱 공식에서:
```
사이즈별 예상 판매량 = 컬러 예상 판매량 × 사이즈별 판매비 × 성장률
```

**문제점**:
- `컬러 예상 판매량` 계산 시 이미 성장률 적용됨
- 사이즈 분배 시 다시 성장률을 곱하면 이중 적용 가능성

---

## 구체적 예시

### 예시 데이터
- 컬러 리오더 수량: 100개
- 전체 판매: 100개, 전체 출고: 100개

| 사이즈 | 판매 수량 | 출고 수량 | 재고 |
|--------|-----------|-----------|------|
| S | 30개 | 40개 | 10개 |
| M | 50개 | 50개 | 20개 |
| L | 20개 | 10개 | 5개 |

### 시즌 리오더 앱 (판매 비율 기준)
- S사이즈: 100 × (30/100) = **30개** (10단위 올림)
- M사이즈: 100 × (50/100) = **50개**
- L사이즈: 100 × (20/100) = **20개**

### 시뮬레이션 앱 (출고 비율 기준)
- S사이즈: 100 × (40/100) = **40개**
- M사이즈: 100 × (50/100) = **50개**
- L사이즈: 100 × (10/100) = **10개**

### 차이 발생
- S사이즈: **+10개** (판매는 적지만 출고가 많았음)
- M사이즈: 동일
- L사이즈: **-10개** (판매는 많지만 출고가 적었음)

---

## 왜 성장률 0%일 때 사이즈가 다른가?

### 컬러 단위
- 두 앱 모두 예상 판매량 계산 시 성장률을 곱함
- 성장률 0% → 예상 판매량 = 0 → 부족 수량 = 0
- **결과: 일치**

### 사이즈 단위
- **시즌 리오더 앱**: 사이즈별 독립 계산 → 성장률 0% → 예상 판매량 0 → 부족 수량 0 → 리오더 수량 0
- **시뮬레이션 앱**: 이미 계산된 컬러 리오더 수량(0)을 출고 비율로 분배 → 0 × 비율 = 0
  - 하지만 **사용자가 직접 컬러 리오더 수량을 입력한 경우**, 해당 값을 출고 비율로 분배하므로 0이 아닌 값 발생 가능
  - 또는 목표 판매율 적용으로 인해 0이 아닌 값이 계산될 수 있음

---

## 추가 확인 필요 사항

### 1. 시뮬레이션 앱의 실제 계산 코드
- `container4.rsx`의 KeyValue 컴포넌트에서 실제 재계산이 어떻게 이루어지는지
- `saveColorEdits.js` 및 `saveSizeEdits.js`에서 어떤 로직으로 값을 업데이트하는지

### 2. 성장률 처리 방식
- 사용자 입력 100%를 1.0으로 처리하는지, 2.0으로 처리하는지
- 두 앱에서 동일한 방식으로 처리하는지

### 3. 사이즈별 성장률 개별 적용
- 시뮬레이션 앱에서는 사이즈별로 개별 성장률 설정 가능 (modalFrame1.rsx:122-126)
- 이 기능이 계산에 어떤 영향을 미치는지

### 4. 목표 판매율 적용 방식
- 시즌 리오더 앱: `reorderRequiredQty = shortageSales / targetSaleRate` (getSelectedItems.js:128)
- 시뮬레이션 앱에서는 목표 판매율을 어떻게 적용하는지

---

## 권장 조치사항

### 즉시 조치 (High Priority)
1. **사이즈 비율 기준 통일**: 판매 비율 vs 출고 비율 중 하나로 통일
2. **계산 로직 문서화**: 두 앱의 정확한 계산 공식을 문서로 명확히 정의
3. **테스트 케이스 작성**: 동일 입력값에 대해 기대되는 결과값 정의

### 중기 조치
1. **리팩토링**: 공통 계산 로직을 모듈화하여 두 앱에서 공유
2. **성장률 입력 UI 개선**: % 입력 시 내부적으로 어떻게 변환되는지 사용자에게 명시
3. **계산 검증 기능**: 두 앱 간 결과 비교 기능 추가

### 장기 조치
1. **단일 계산 엔진**: 하나의 계산 로직으로 통합하여 일관성 보장
2. **자동화된 테스트**: CI/CD 파이프라인에 계산 로직 검증 추가

---

## 관련 파일 목록

### 시즌 리오더 앱
- `apps/99. Module/리오더/(module) 시즌 리오더 메인 테이블/functions.rsx`
- `apps/99. Module/리오더/(module) 시즌 리오더 메인 테이블/main.rsx`
- `apps/99. Module/리오더/(module) 시즌 리오더 메인 테이블/lib/getSelectedItems.js`
- `apps/99. Module/리오더/(module) 시즌 리오더 메인 테이블/lib/get_item_list.sql`
- `apps/99. Module/리오더/(module) 시즌 리오더 메인 테이블/lib/getColorList.js`

### 시즌 리오더 시뮬레이션 앱
- `apps/01. EttoiApp/02. 리오더/시즌 리오더 시뮬레이션 - 에뜨와/src/defaultPage.rsx`
- `apps/01. EttoiApp/02. 리오더/시즌 리오더 시뮬레이션 - 에뜨와/src/container4.rsx`
- `apps/01. EttoiApp/02. 리오더/시즌 리오더 시뮬레이션 - 에뜨와/src/modalFrame1.rsx`
- `apps/01. EttoiApp/02. 리오더/시즌 리오더 시뮬레이션 - 에뜨와/lib/saveColorEdits.js`
- `apps/01. EttoiApp/02. 리오더/시즌 리오더 시뮬레이션 - 에뜨와/lib/saveSizeEdits.js`
- `apps/01. EttoiApp/02. 리오더/시즌 리오더 시뮬레이션 - 에뜨와/lib/getReorderSimulationTargets.sql`

---

**작성자**: Claude Code
**분석 기간**: 2026-01-26
