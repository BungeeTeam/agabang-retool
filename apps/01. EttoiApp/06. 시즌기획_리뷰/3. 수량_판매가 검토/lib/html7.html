<div class="card-container">

{{

  (() => {

    const colorDict = JSON.parse(retoolContext.configVars.var_color_dict);

    const items = formatDataAsArray(get_item_list.data)

      .filter(item =>

        item.item_price == var_price_list.value[i] &&

        item.year_sesn_nm_eng == var_season_list.value[0]

      );



    return items.map(item => {

      const saleRate = item.tot_in_qty > 0

        ? ((item.tot_sale_qty / item.tot_in_qty) * 100).toFixed(0)

        : '0';



      const colorCode = colorDict[item.col_nm] || '#ccc';

      const input = JSON.parse(item?.final_assort || '{}');

      const sizes = item

        .size_nm_list

        .replace(/^\[|\]$/g, '')  // Remove square brackets more robustly

        .split(',')  // Split by comma

        .map(size => size.trim().replace(/^['"]|['"]$/g, ''));  // Trim and remove quotes

      

      // qty가 0 이상인 항목만 필터링하고, col_X 형식으로 구성

      const positiveQtyItems = Object.entries(input)

        .filter(([_, val]) => val.qty > 0) // qty > 0인 항목만 필터

        .slice(0, sizes.length);           // 필요한 개수만큼 자르기

  

      const filtered = positiveQtyItems.map(([key, val], idx) => ({

        col: `col_${idx + 1}`,

        size: sizes[idx],

        qty: val.qty

      }));

  

      const col1 = {};

      const col2 = {};

      

      filtered.forEach((item, index) => {

        const colKey = `col_${index + 1}`;

        col1[colKey] = item.size;

        col2[colKey] = Number(item.qty).toFixed(0);

      });

      

      // col1 = 사이즈 row, col2 = 수량 row → sizeQtyHtml 생성

      const sizeQtyHtml = Object.keys(col1).map((key) => {

        const size = col1[key];

        const qty = col2[key];

        return `

          <div class="item">

            <div class="item-label">${size}</div>

            <div class="item-value">${qty}</div>

          </div>

        `;

      }).join('');



      return `

        <div class="card">

          <h5>${item.sty_cd || ''}</h5>

          <h5>${item.sty_nm || ''}</h5>

          <p class="badge" style="background-color:${colorCode}">${item.col_nm || ''}</p>

          <img class="img" src="https://agabang-image.s3.ap-northeast-2.amazonaws.com/item_final/${item.sty_cd}${item.col_cd}.jpg" alt="제품 사진" />



          <p class="small"><span class="bold">생산처 |</span> ${item.prod_comp || ''}</p>

          <p class="small"><span class="bold">소재 |</span> ${item.fabric || ''}</p>

          <p class="small"><span class="bold">판매율 |</span> ${saleRate}%</p>



          <hr />



          <h6>생산량 : ${item.tot_in_qty || 0}</h6>

          <div class="container">

            ${sizeQtyHtml}

          </div>



          <h6>판매가/원가</h6>

          <div class="container">

            <div class="item">

              <div class="item-label">최종</div>

              <div class="item-value">${Number(item.item_price).toLocaleString() || ''}</div>

              <div class="item-value small">( ${Number(item.cost_price) == 0 ? "-":  (Number(item.item_price)/Number(item.cost_price*1.1)).toFixed(2) } )</div>

            </div>

          </div>



          <div class="container">

            <div class="item">

              <div class="item-label">VAT(-)</div>

              <div class="item-value">${ Number(item.cost_price).toLocaleString() || ''}</div>

            </div>

            <div class="item">

              <div class="item-label">VAT(+)</div>

              <div class="item-value">${ Number((item.cost_price*1.1).toFixed(0)).toLocaleString(0) || ''}</div>

            </div>

          </div>

          

          <hr />

          

          <h6>메모</h6>

          <div class="container memo-container">

            <div class="item memo-item">

              <input class="memo-input" 

                     id="memo_input" 

                     data-change-target="memo_target" 

                     value="${item.price_memo !== null? item.price_memo: ''}" 

                     placeholder="메모를 입력해주세요" />

            </div>

            <div class="item memo-btn-item">

              <button class="memo-btn" 

                      id="memo_btn" 

                      data-click-target="memo_click" 

                      value="${item.sty_cd + "|" + item.col_cd}">저장</button>

            </div>

          </div>

        </div>

      `;

    }).join('');

  })()

}}

</div>

<style>
.card-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  width: 100%;
}

.card {
  border: 1px solid #e0e0e0;
  padding: 8px;
  margin: 0;
  font-size: 11px;
  color: #000000;
}

.card img {
  display: block;
  width: 70%;
  margin-bottom: 8px;
}

.card h5 {
  font-size: 12px;
  margin: 4px 0;
  padding: 0;
}

.card h6 {
  font-size: 11px;
  margin: 16px 0 4px;
  padding: 0;
}

.card p {
  margin: 4px 0 0;
}

.card .badge {
  display: inline-block;
  background-color: #eee;
  margin: 4px 0 12px;
  padding: 2px 8px;
  font-size: 12px;
  border-radius: 12px;
}

.card hr {
  border: none;
  border-top: 1px solid #e0e0e0;
  margin: 12px 0;
}

.container {
  display: flex;
  width: 100%;
  background-color: #f9f9f9;
  padding: 4px 0;
  margin-bottom: 4px;
}

.item {
  flex: 1;
  padding: 0 4px;
  text-align: center;
  border-right: 1px #ccc solid;
}

.item:last-child {
  border-right: 0;
}

.item-label {
  font-weight: bold;
  margin-bottom: 4px;
}

.item-value {
  margin-bottom: 2px;
}

.small {
  font-size: 0.9em;
  padding-bottom: 0;
}

.bold {
  font-weight: bold;
}

.price-section {
  background-color: #f9f9f9;
  padding: 10px;
  border-radius: 4px;
}

/* 메모 관련 추가 스타일 */
.memo-item {
  flex: 3;
  padding: 0 4px;
  text-align: left;
  border-right: 1px #ccc solid;
}

.memo-input {
  width: 100%;
  padding: 4px 6px;
  border: 1px solid #ddd;
  border-radius: 3px;
  font-size: 11px;
  background-color: #fff;
  box-sizing: border-box;
}

.memo-input:focus {
  outline: none;
  border-color: #666;
}

.memo-input::placeholder {
  color: #aaa;
  font-size: 10px;
}

.memo-btn-item {
  flex: 1;
  padding: 0 4px;
  text-align: center;
  border-right: 0;
}

.memo-btn {
  width: 100%;
  padding: 4px 6px;
  background-color: transparent;
  color: #333;
  border: 1px solid #ddd;
  border-radius: 3px;
  font-size: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.memo-btn:hover {
  background-color: #f8f9fa;
  border-color: #adb5bd;
}

.memo-btn:active {
  background-color: #e9ecef;
}
</style>