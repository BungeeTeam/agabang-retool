<div class="card-container">

{{

  (() => {

    const colorDict = JSON.parse(retoolContext.configVars.var_color_dict);

    const items = formatDataAsArray(get_item_list.data)

      .filter(item =>

        item.item_price == var_price_list.value[i] &&

        item.year_sesn_nm_eng == var_season_list.value[0]

      );



    return items.map(item => {

      const saleRate = item.tot_in_qty > 0

        ? ((item.tot_sale_qty / item.tot_in_qty) * 100).toFixed(0)

        : '0';



      const colorCode = colorDict[item.col_nm] || '#ccc';

      const input = JSON.parse(item?.final_assort || '{}');

      const sizes = item

        .size_nm_list

        .replace(/^\[|\]$/g, '')  // Remove square brackets more robustly

        .split(',')  // Split by comma

        .map(size => size.trim().replace(/^['"]|['"]$/g, ''));  // Trim and remove quotes

      

      // qty가 0 이상인 항목만 필터링하고, col_X 형식으로 구성

      const positiveQtyItems = Object.entries(input)

        .filter(([_, val]) => val.qty > 0) // qty > 0인 항목만 필터

        .slice(0, sizes.length);           // 필요한 개수만큼 자르기

  

      const filtered = positiveQtyItems.map(([key, val], idx) => ({

        col: `col_${idx + 1}`,

        size: sizes[idx],

        qty: val.qty

      }));

  

      const col1 = {};

      const col2 = {};

      

      filtered.forEach((item, index) => {

        const colKey = `col_${index + 1}`;

        col1[colKey] = item.size;

        col2[colKey] = Number(item.qty).toFixed(0);

      });

      

      // col1 = 사이즈 row, col2 = 수량 row → sizeQtyHtml 생성

      const sizeQtyHtml = Object.keys(col1).map((key) => {

        const size = col1[key];

        const qty = col2[key];

        return `

          <div class="item">

            <div class="item-label">${size}</div>

            <div class="item-value">${qty}</div>

          </div>

        `;

      }).join('');



      return `

      <div class="product">

        <div class="card">

          <h5>${item.sty_cd || ''}</h5>

          <h5>${item.sty_nm || ''}</h5>

          <p class="badge" style="background-color:${colorCode}">${item.col_nm || ''}</p>

          <img class="img" src="https://agabang-image.s3.ap-northeast-2.amazonaws.com/item_final/${item.sty_cd}${item.col_cd}.jpg" alt="제품 사진" />



          <p class="small"><span class="bold">생산처 |</span> ${item.prod_comp || ''}</p>

          <p class="small"><span class="bold">소재 |</span> ${item.fabric || ''}</p>

          <p class="small"><span class="bold">판매율 |</span> ${saleRate}%</p>



          <hr />



          <h6>생산량 : ${item.tot_in_qty || 0}</h6>

          <div class="container">

            ${sizeQtyHtml}

          </div>



          <h6>판매가/원가</h6>

          <div class="container">

            <div class="item">

              <div class="item-label">최종</div>

              <div class="item-value">${Number(item.item_price).toLocaleString() || ''}</div>

              <div class="item-value small">( ${Number(item.cost_price) == 0 ? "-":  (Number(item.item_price)/Number(item.cost_price*1.1)).toFixed(2) } )</div>

            </div>

          </div>



          <div class="container">

            <div class="item">

              <div class="item-label">VAT(-)</div>

              <div class="item-value">${ Number(item.cost_price).toLocaleString() || ''}</div>

            </div>

            <div class="item">

              <div class="item-label">VAT(+)</div>

              <div class="item-value">${ Number((item.cost_price*1.1).toFixed(0)).toLocaleString(0) || ''}</div>

            </div>

          </div>

          

          <hr />

          

          <h6>메모</h6>

          <div class="container memo-container">

            <div class="item memo-item">

              <input class="memo-input" 

                     id="memo_input" 

                     data-change-target="memo_target" 

                     value="${item.price_memo !== null? item.price_memo: ''}" 

                     placeholder="메모를 남겨주세요" />

            </div>

            <div class="item memo-btn-item">

              <button class="memo-btn" 

                      id="memo_btn" 

                      data-click-target="memo_click" 

                      value="${item.sty_cd + "|" + item.col_cd}">저장</button>

            </div>

          </div>

        </div>

      </div>

      `;

    }).join('');

  })()

}}

</div>